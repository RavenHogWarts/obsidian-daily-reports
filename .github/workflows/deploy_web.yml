name: Deploy Web Dashboard

on:
  workflow_run:
    workflows:
      [
        "Daily Obsidian Report Data Fetcher",
        "Weekly Obsidian Report Aggregator",
      ]
    types:
      - completed
    branches:
      - master
  workflow_dispatch:

jobs:
  sync-data:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: write

    steps:
      - name: Checkout web branch
        uses: actions/checkout@v4
        with:
          ref: web
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN || github.token }}

      - name: Setup Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      # 使用 git subtree 从 master 分支同步 data 目录
      # 这样数据不会被重复存储，而是直接引用
      - name: Sync data using git subtree
        run: |
          echo "Syncing data from master branch using git subtree..."
          
          # 添加 master 作为远程（如果尚未添加）
          git remote add master-branch https://github.com/${{ github.repository }}.git 2>/dev/null || true
          git fetch master-branch master
          
          # 使用 subtree pull 来同步 data 目录
          # 如果第一次使用，需要先 add
          if [ ! -d "public/data" ]; then
            git subtree add --prefix=public/data master-branch master:data --squash
          else
            git subtree pull --prefix=public/data master-branch master:data --squash -m "chore: sync data from master"
          fi

      - name: Push changes
        run: |
          # subtree pull 已经创建了commit，直接push
          git push origin web || echo "No changes to push"
